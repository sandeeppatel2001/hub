
services:
  # Session Manager - Orchestrates browser containers
  session-manager:
    build: ./session-manager
    container_name: session-manager
    ports:
      - "3000:3000"
    environment:
      - REDIS_URL=redis://redis:6379
      - BROWSER_IMAGE=browser-interceptor:latest
      - BASE_NOVNC_PORT=8100
      - BASE_CDP_PORT=9300
      - SESSION_TIMEOUT=7200
      - BASE_URL=http://localhost
      - S3_BUCKET=browser-logs
      - S3_ENDPOINT=http://minio:9000
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=minioadmin123
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - redis
      - minio
    restart: unless-stopped
    networks:
      - browser-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Redis - Session state storage
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - browser-network

  # MinIO - S3-compatible object storage for logs
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=minioadmin123
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    restart: unless-stopped
    networks:
      - browser-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MinIO Client - Create bucket on startup
  minio-init:
    image: minio/mc:latest
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      /usr/bin/mc alias set myminio http://minio:9000 admin minioadmin123;
      /usr/bin/mc mb myminio/browser-logs --ignore-existing;
      /usr/bin/mc anonymous set download myminio/browser-logs;
      exit 0;
      "
    networks:
      - browser-network

  # Nginx - Reverse proxy for session routing
  nginx:
    image: nginx:alpine
    container_name: nginx
    network_mode: host
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - session-manager
    restart: unless-stopped

volumes:
  redis-data:
  minio-data:

networks:
  browser-network:
    driver: bridge
