FROM debian:12-slim

ARG DEBIAN_FRONTEND=noninteractive

# -------------------------------------------------
# 1. Install system dependencies
# -------------------------------------------------
RUN apt update && apt install -y \
    curl \
    wget \
    git \
    unzip \
    tzdata \
    xvfb \
    x11vnc \
    fluxbox \
    chromium \
    nodejs \
    npm \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# -------------------------------------------------
# 2. Install noVNC
# -------------------------------------------------
RUN git clone --depth 1 https://github.com/novnc/noVNC /opt/noVNC && \
    git clone --depth 1 https://github.com/novnc/websockify /opt/noVNC/utils/websockify

# -------------------------------------------------
# 3. Install Node deps & copy app files
# -------------------------------------------------
WORKDIR /app
COPY package.json .
RUN npm install --production
COPY playwright.js .

# -------------------------------------------------
# 4. Add start script
# -------------------------------------------------
COPY start.sh /start.sh
RUN chmod +x /start.sh

# -------------------------------------------------
# 5. Environment variables (set by session manager)
# -------------------------------------------------
ENV SESSION_ID=""
ENV TARGET_URL="https://www.google.com"
ENV S3_BUCKET=""
ENV S3_KEY=""
ENV S3_ENDPOINT=""
ENV AWS_ACCESS_KEY_ID=""
ENV AWS_SECRET_ACCESS_KEY=""

EXPOSE 8080 9222

CMD ["/start.sh"]

